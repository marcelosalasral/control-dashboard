<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Sitio 1 â€“ Dashboard ReproducciÃ³n</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#f3f6f9;
      --card:#ffffff;
      --muted:#5a6772;
      --accent:#1f6feb;
      --success:#2b8f45;
      --warn:#e67e22;
      --danger:#c0392b;
      --maxwidth:1100px;
    }
    *{box-sizing:border-box}
    body{
      background:var(--bg);
      color:#233043;
      font-family:Inter, "Segoe UI", Arial, sans-serif;
      margin:0;
      padding:22px;
      display:flex;
      justify-content:center;
    }
    .wrap{
      width:100%;
      max-width:var(--maxwidth);
    }
    header{margin-bottom:12px}
    h1{margin:0;font-size:22px}
    .sub{color:var(--muted);margin-top:6px;margin-bottom:18px}

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:12px;
    }

    .back-btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      background:#0b74e6;
      color:white;
      text-decoration:none;
      border-radius:6px;
      font-weight:600;
      font-size:14px;
    }
    .back-btn small{opacity:0.9;font-weight:500}

    .kpi-row{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px}
    .kpi{
      background:var(--card);
      padding:12px;
      border-radius:10px;
      box-shadow:0 1px 6px rgba(16,24,40,0.05);
      min-width:160px;
      flex:1 1 160px;
    }
    .kpi small{display:block;color:var(--muted);font-size:12px}
    .kpi .value{font-size:20px;font-weight:700;margin-top:6px}

    .panel{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 1px 6px rgba(16,24,40,0.04);margin-bottom:14px}
    .panel h2{margin:0 0 8px 0;font-size:16px}
    #estado{color:var(--muted);margin-bottom:8px}

    canvas{width:100% !important;height:320px !important;border-radius:8px}

    table{width:100%;border-collapse:collapse;background:var(--card);border-radius:8px;overflow:hidden}
    th,td{padding:8px 10px;text-align:right;border-bottom:1px solid #eef2f6;font-size:13px}
    th{background:#f0f5fb;color:#223}
    td.fecha{text-align:left;white-space:nowrap}
    tbody tr:last-child td{border-bottom:none}

    .error{color:var(--danger);font-weight:700;margin-bottom:10px}
    @media (max-width:740px){
      canvas{height:260px !important}
      .kpi { min-width:140px }
      .topbar { flex-direction:column; align-items:flex-start; gap:8px; }
    }

    /* colores para indicadores de cumplimiento */
    .kpi.meets { border-left: 6px solid var(--success); }
    .kpi.below  { border-left: 6px solid var(--danger); }

    .kpi.meets .value { color: var(--success); }
    .kpi.below .value  { color: var(--danger); }

    /* resumen pequeÃ±o */
    .small-muted { color:var(--muted); font-size:13px; margin-top:8px }
  </style>
</head>
<body>
  <div class="wrap">

    <div class="topbar">
      <a class="back-btn" href="../../index.html" title="Volver al Ã­ndice general">â¬… Volver
        <small>Dashboard general</small>
      </a>

      <div style="text-align:right">
        <div style="font-weight:700">Sitio 1 â€” ReproducciÃ³n</div>
        <div class="small-muted">UFL: <strong>F14CCB3B7</strong> Â· Fuente: FactBreeding (JSON)</div>
      </div>
    </div>

    <header>
      <h1>ðŸ‘‘ Sitio 1 â€“ Dashboard ReproducciÃ³n</h1>
    </header>

    <!-- KPI row (Ãºnica) -->
    <div class="kpi-row">
      <div id="card_services" class="kpi">
        <small>Inseminaciones (promedio Ãºltimas 10s)</small>
        <div id="kpi_services" class="value">â€”</div>
        <div class="small-muted">Meta semanal: <strong id="meta_services">91</strong></div>
      </div>

      <div id="card_birthings" class="kpi">
        <small>Partos (promedio Ãºltimas 10s)</small>
        <div id="kpi_birthings" class="value">â€”</div>
        <div class="small-muted">Meta semanal: <strong id="meta_birthings">83</strong></div>
      </div>

      <div id="card_nweaned" class="kpi">
        <small>Destetes (promedio Ãºltimas 10s)</small>
        <div id="kpi_nweaned" class="value">â€”</div>
        <div class="small-muted">Meta semanal: <strong id="meta_nweaned">1132</strong></div>
      </div>

      <div class="kpi">
        <small>Piglets / parto Â· Conv. proxy</small>
        <div style="display:flex;gap:10px;align-items:center">
          <div id="kpi_ppp" class="value">â€”</div>
          <div id="kpi_conv" class="value" style="font-size:15px;color:var(--muted)">â€”</div>
        </div>
      </div>
    </div>

    <div id="estado">Cargando datos...</div>

    <div class="panel">
      <h2>GrÃ¡fico semanal â€” Inseminaciones Â· Partos Â· Destetes</h2>
      <canvas id="chartRepro"></canvas>
    </div>

    <div class="panel">
      <h2>Detalle por semana</h2>
      <div id="resumen" class="sub"></div>
      <div style="overflow:auto">
        <table id="tabla">
          <thead>
            <tr>
              <th>Semana / Fecha</th>
              <th>Inseminaciones</th>
              <th>Partos</th>
              <th>Destetes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="small-muted" style="margin-top:6px">
      Nota: las semanas vienen en formato <code>YYYYWW</code> (ej. 202310). Los KPIs usan promedio de las Ãºltimas 10 semanas.
    </div>
  </div>

  <script>
    // utilidades
    function isoWeekToDateLabel(yyyyww) {
      const s = String(yyyyww);
      if (s.length < 6) return s;
      const year = parseInt(s.slice(0,4),10);
      const week = parseInt(s.slice(4),10);
      if (!year || !week) return s;
      const simple = new Date(Date.UTC(year,0,4));
      const dayOfWeek = simple.getUTCDay() || 7;
      const isoWeek1Start = new Date(simple);
      isoWeek1Start.setUTCDate(simple.getUTCDate() - dayOfWeek + 1);
      const weekStart = new Date(isoWeek1Start);
      weekStart.setUTCDate(isoWeek1Start.getUTCDate() + (week - 1) * 7);
      return weekStart.toLocaleDateString();
    }

    function movingAverage(arr,n=4){
      const res = [];
      for(let i=0;i<arr.length;i++){
        const start = Math.max(0, i - n + 1);
        const sub = arr.slice(start, i+1);
        const sum = sub.reduce((a,b)=>a+b,0);
        res.push(sum / sub.length);
      }
      return res;
    }

    function avgLastN(arr, n=10) {
      if (!Array.isArray(arr) || arr.length === 0) return 0;
      const sliceArr = arr.slice(-n);
      const sum = sliceArr.reduce((s,v)=>s + (Number(v)||0), 0);
      return sliceArr.length ? (sum / sliceArr.length) : 0;
    }

    async function cargarDatos() {
      const estado = document.getElementById('estado');
      try {
        const resp = await fetch('../data/factbreeding_sitio1.json', {cache: "no-store"});
        if (!resp.ok) throw new Error('No se pudo cargar el JSON ('+resp.status+')');
        const datos = await resp.json();

        if (!Array.isArray(datos) || datos.length === 0) {
          estado.textContent = 'No hay datos en factbreeding_sitio1.json';
          return;
        }

        // ordenar por date
        datos.sort((a,b)=> (''+a.date).localeCompare(''+b.date, undefined, {numeric:true}));

        // arrays
        const labels = datos.map(d => isoWeekToDateLabel(d.date || ''));
        const serv = datos.map(d => Number(d.services||0));
        const birth = datos.map(d => Number(d.birthings||0));
        const wean = datos.map(d => Number(d.nweaned||0));

        // Usar solo las Ãºltimas N semanas en el grÃ¡fico
        const LAST_N = 10;
        const labels10 = labels.slice(-LAST_N);
        const serv10   = serv.slice(-LAST_N);
        const birth10  = birth.slice(-LAST_N);
        const wean10   = wean.slice(-LAST_N);

        // promedios ultimas 10 semanas (KPI)
        const avgServices10 = avgLastN(serv, 10);
        const avgBirth10 = avgLastN(birth, 10);
        const avgWean10 = avgLastN(wean, 10);

        // metas
        const TARGETS = { services: 91, birthings: 83, nweaned: 1132 };

        const fmt = v => Math.round(v).toLocaleString();

        document.getElementById('kpi_services').textContent = fmt(avgServices10);
        document.getElementById('kpi_birthings').textContent = fmt(avgBirth10);
        document.getElementById('kpi_nweaned').textContent = fmt(avgWean10);

        function applyColor(cardId, avgValue, target) {
          const card = document.getElementById(cardId);
          if (!card) return;
          card.classList.remove('meets','below');
          if (avgValue >= target) card.classList.add('meets');
          else card.classList.add('below');
        }

        applyColor('card_services', avgServices10, TARGETS.services);
        applyColor('card_birthings', avgBirth10, TARGETS.birthings);
        applyColor('card_nweaned', avgWean10, TARGETS.nweaned);

        // totales y otros KPI (solo en resumen)
        const totalServ = serv.reduce((s,v)=>s+v,0);
        const totalBirth = birth.reduce((s,v)=>s+v,0);
        const totalWean = wean.reduce((s,v)=>s+v,0);

        const pigletsPerBirth = totalBirth ? (totalWean / totalBirth) : 0;
        const conceptionProxy = totalServ ? (totalBirth / totalServ) : 0;

        document.getElementById('kpi_ppp').textContent = pigletsPerBirth ? pigletsPerBirth.toFixed(2) + ' piglets/parto' : '-';
        document.getElementById('kpi_conv').textContent = conceptionProxy ? ((conceptionProxy*100).toFixed(1) + '%') : '-';

        // resumen textual
        document.getElementById('resumen').textContent = `Total periodo â€“ Inseminaciones: ${totalServ.toLocaleString()} Â· Partos: ${totalBirth.toLocaleString()} Â· Destetes: ${totalWean.toLocaleString()}`;
        estado.textContent = `Registros cargados: ${datos.length} semanas`;

        // medias moviles
        const servMA = movingAverage(serv,4);
        const birthMA = movingAverage(birth,4);
        const weanMA = movingAverage(wean,4);

        // grÃ¡fico
        const ctx = document.getElementById('chartRepro').getContext('2d');
        if (window._reproChart) window._reproChart.destroy();
        window._reproChart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: labels10,
              datasets: [
                { label: 'Inseminaciones', data: serv10, borderWidth: 2, tension:0.2 },
                { label: 'Inseminaciones MA(4)', data: movingAverage(serv10,4), borderDash: [6,4], borderWidth:1.5, tension:0.2 },
                { label: 'Partos', data: birth10, borderWidth: 2, tension:0.2 },
                { label: 'Partos MA(4)', data: movingAverage(birth10,4), borderDash: [6,4], borderWidth:1.5, tension:0.2 },
                { label: 'Destetes', data: wean10, borderWidth: 2, tension:0.2 },
                { label: 'Destetes MA(4)', data: movingAverage(wean10,4), borderDash: [6,4], borderWidth:1.5, tension:0.2 }
              ]
            },
            options: {
              responsive:true,
              maintainAspectRatio:false,
              interaction:{mode:'index',intersect:false},
              plugins:{legend:{display:true}},
              scales:{
                x:{ ticks:{ maxTicksLimit: 10, autoSkip:true } }, 
                y:{ beginAtZero:true }
              }
            }
          });


        // tabla
        const tbody = document.querySelector('#tabla tbody');
        tbody.innerHTML = '';
        for (let i=0;i<datos.length;i++){
          const row = datos[i];
          const tr = document.createElement('tr');
          const tdDate = document.createElement('td'); tdDate.className='fecha';
          tdDate.textContent = labels[i] || row.date || '';
          tr.appendChild(tdDate);
          const tdS = document.createElement('td'); tdS.textContent = row.services || 0; tr.appendChild(tdS);
          const tdB = document.createElement('td'); tdB.textContent = row.birthings || 0; tr.appendChild(tdB);
          const tdW = document.createElement('td'); tdW.textContent = row.nweaned || 0; tr.appendChild(tdW);
          tbody.appendChild(tr);
        }

      } catch (err) {
        console.error(err);
        document.getElementById('estado').textContent = '';
        const e = document.createElement('div');
        e.className='error';
        e.textContent = 'Error al cargar datos: ' + err.message;
        document.querySelector('.wrap').prepend(e);
      }
    }

    // arrancar
    cargarDatos();
  </script>
</body>
</html>
